
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>nbodykit.cosmology.cosmology &#8212; HorizonGRound 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/HorizonGRound.png" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_recipes.html">Quick Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc.html">API Reference</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for nbodykit.cosmology.cosmology</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">classylss.binding</span> <span class="kn">import</span> <span class="n">ClassEngine</span><span class="p">,</span> <span class="n">Background</span><span class="p">,</span> <span class="n">Spectra</span><span class="p">,</span> <span class="n">Perturbs</span><span class="p">,</span> <span class="n">Primordial</span><span class="p">,</span> <span class="n">Thermo</span>
<span class="kn">from</span> <span class="nn">classylss.astropy_compat</span> <span class="kn">import</span> <span class="n">AstropyCompat</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">string_types</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">store_user_kwargs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that adds the ``_user_kwargs`` attribute to the class to track</span>
<span class="sd">    which arguments the user actually supplied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">class</span> <span class="nc">Cosmology</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A cosmology calculator based on the CLASS binding in :mod:`classylss`.</span>

<span class="sd">    It is a collection of all method provided by the CLASS interfaces.</span>
<span class="sd">    The object is immutable. To obtain an instance with a new set of parameters</span>
<span class="sd">    use :func:`clone` or :func:`match`.</span>

<span class="sd">    The individual interfaces can be accessed too, such that</span>
<span class="sd">    `c.Spectra.get_transfer` and `c.get_transfer` are identical.</span>

<span class="sd">    .. important::</span>

<span class="sd">        A default set of units is assumed. Those units are:</span>

<span class="sd">        * temperature: :math:`\mathrm{K}`</span>
<span class="sd">        * distance: :math:`h^{-1} \mathrm{Mpc}`</span>
<span class="sd">        * wavenumber: :math:`h \mathrm{Mpc}^{-1}`</span>
<span class="sd">        * power: :math:`h^{-3} \mathrm{Mpc}^3`</span>
<span class="sd">        * density: :math:`10^{10} (M_\odot/h) (\mathrm{Mpc}/h)^{-3}`</span>
<span class="sd">        * neutrino mass: :math:`\mathrm{eV}`</span>
<span class="sd">        * time: :math:`\mathrm{Gyr}`</span>
<span class="sd">        * :math:`H_0`: :math:`(\mathrm{km} \ \mathrm{s^{-1}}) / (h^{-1} \ \mathrm{Mpc})`</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * The default configuration assumes a flat cosmology, :math:`\Omega_{0,k}=0`.</span>
<span class="sd">      Pass ``Omega0_k`` as a keyword to specify the desired non-flat curvature.</span>
<span class="sd">    * For consistency of variable names, the present day values can be passed</span>
<span class="sd">      with or without &#39;0&#39; postfix, e.g., ``Omega0_cdm`` is translated to</span>
<span class="sd">      ``Omega_cdm`` as CLASS always uses the names without `0` as input</span>
<span class="sd">      parameters.</span>
<span class="sd">    * By default, a cosmological constant (``Omega0_lambda``) is assumed, with</span>
<span class="sd">      its density value inferred by the curvature condition.</span>
<span class="sd">    * Non-cosmological constant dark energy can be used by specifying the</span>
<span class="sd">      ``w0_fld``, ``wa_fld``, and/or ``Omega_fld`` values.</span>
<span class="sd">    * To pass in CLASS parameters that are not valid Python argument names, use</span>
<span class="sd">      the dictionary/keyword arguments trick, e.g.</span>
<span class="sd">      ``Cosmology(..., **{&#39;temperature contributions&#39;: &#39;y&#39;})``</span>
<span class="sd">    * ``Cosmology(**dict(c))`` is not supposed to work; use ``Cosmology.from_dict(dict(c))``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h : float</span>
<span class="sd">        the dimensionless Hubble parameter</span>
<span class="sd">    T0_cmb : float</span>
<span class="sd">        the temperature of the CMB in Kelvins</span>
<span class="sd">    Omega0_b : float</span>
<span class="sd">        the current baryon density parameter, :math:`\Omega_{b,0}`. Currently</span>
<span class="sd">        unrealistic cosmology where Omega_b == 0 is not supported.</span>
<span class="sd">    Omega0_cdm : float</span>
<span class="sd">        the current cold dark matter density parameter, :math:`\Omega_{cdm,0}`</span>
<span class="sd">    N_ur : float</span>
<span class="sd">        the number of ultra-relativistic (massless neutrino) species; the</span>
<span class="sd">        default number is inferred based on the number of massive neutrinos</span>
<span class="sd">        via the following logic: if you have respectively 1,2,3 massive</span>
<span class="sd">        neutrinos and use the default ``T_ncdm`` value (0.71611 K), designed</span>
<span class="sd">        to give m/omega of 93.14 eV, and you wish to have ``N_eff=3.046`` in</span>
<span class="sd">        the early universe, then ``N_ur`` is set to 2.0328, 1.0196, 0.00641,</span>
<span class="sd">        respectively.</span>
<span class="sd">    m_ncdm : list, None</span>
<span class="sd">        the masses (in eV) for all massive neutrino species; an empty list</span>
<span class="sd">        should  be passed for no massive neutrinos. The default is a single</span>
<span class="sd">        massive neutrino with mass of 0.06 eV</span>
<span class="sd">    P_k_max : float</span>
<span class="sd">        the maximum ``k`` value to compute power spectrum results to, in units</span>
<span class="sd">        of :math:`h/Mpc`</span>
<span class="sd">    P_z_max : float</span>
<span class="sd">        the maximum redshift to compute power spectrum results to</span>
<span class="sd">    gauge : str,</span>
<span class="sd">        either synchronous or newtonian</span>
<span class="sd">    n_s : float</span>
<span class="sd">        the tilt of the primordial power spectrum</span>
<span class="sd">    nonlinear : bool</span>
<span class="sd">        whether to compute nonlinear power spectrum results via HaloFit</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        whether to turn on the default CLASS logging for all submodules</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        extra keyword parameters to pass to CLASS. Mainly used to pass-in</span>
<span class="sd">        parameter names that are not valid Python function argument names,</span>
<span class="sd">        e.g. ``temperature contributions``, or ``number count contributions``.</span>
<span class="sd">        Users should be wary of configuration options that may conflict</span>
<span class="sd">        with the base set of parameters. To override parameters, chain the</span>
<span class="sd">        result with :func:`clone`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># delegate resolve order -- a pun at mro; which in</span>
    <span class="c1"># this case introduces the meta class bloat and doesn&#39;t solve</span>
    <span class="c1"># the issue. We want delayed initialization of interfaces</span>
    <span class="c1"># or so-called &#39;mixins&#39;.</span>
    <span class="c1"># easier to just use delegates with a customized getattr.</span>
    <span class="c1"># this doesn&#39;t work well with automated documentation tools though,</span>
    <span class="c1"># unfortunately.</span>

    <span class="n">dro</span> <span class="o">=</span> <span class="p">[</span><span class="n">AstropyCompat</span><span class="p">,</span> <span class="n">Thermo</span><span class="p">,</span> <span class="n">Spectra</span><span class="p">,</span> <span class="n">Perturbs</span><span class="p">,</span> <span class="n">Primordial</span><span class="p">,</span> <span class="n">Background</span><span class="p">,</span> <span class="n">ClassEngine</span><span class="p">]</span>
    <span class="n">dro_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">n</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">dro</span><span class="p">])</span>

    <span class="nd">@store_user_kwargs</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">h</span><span class="o">=</span><span class="mf">0.67556</span><span class="p">,</span>
            <span class="n">T0_cmb</span><span class="o">=</span><span class="mf">2.7255</span><span class="p">,</span>
            <span class="n">Omega0_b</span><span class="o">=</span><span class="mf">0.022032</span><span class="o">/</span><span class="mf">0.67556</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">Omega0_cdm</span><span class="o">=</span><span class="mf">0.12038</span><span class="o">/</span><span class="mf">0.67556</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">N_ur</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">m_ncdm</span><span class="o">=</span><span class="p">[</span><span class="mf">0.06</span><span class="p">],</span>
            <span class="n">P_k_max</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
            <span class="n">P_z_max</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span>
            <span class="n">gauge</span><span class="o">=</span><span class="s1">&#39;synchronous&#39;</span><span class="p">,</span>
            <span class="n">n_s</span><span class="o">=</span><span class="mf">0.9667</span><span class="p">,</span>
            <span class="n">nonlinear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span> <span class="c1"># additional arguments to pass to CLASS</span>
        <span class="p">):</span>

        <span class="c1"># quickly copy over all arguments --</span>
        <span class="c1"># at this point locals only contains the arguments.</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

        <span class="c1"># store the extra CLASS params</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">)</span>

        <span class="c1"># remove some non-CLASS variables</span>
        <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>

        <span class="c1"># check for deprecated init signature</span>
        <span class="n">deprecated_args</span> <span class="o">=</span> <span class="n">check_deprecated_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deprecated_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># check for conflicts between named args user passed and</span>
            <span class="c1"># deprecated args passed via **kwargs</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">deprecated_args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter conflicts; use &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter only&quot;</span> <span class="o">%</span><span class="n">a</span><span class="p">)</span>

            <span class="c1"># if we make it here, it is a valid deprecated syntax</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s2">&quot;This init signature is deprecated; see the Cosmology &quot;</span>
                           <span class="s2">&quot;docstring for new signature&quot;</span><span class="p">),</span> <span class="ne">FutureWarning</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">deprecated_args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># merge the kwargs; without resolving conflicts.</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># check for input conflicts (using kwargs user actually input)</span>
        <span class="n">check_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_kwargs</span><span class="p">)</span>

        <span class="c1"># verify and set defaults</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">compile_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># use set state to de-serialize the object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dict string when printed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows dict() to be used on class.</span>
<span class="sd">        Use :func:`from_dict` to reconstruct an instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">pars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; a list of all members from all delegate classes &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># first allow tab completion of delegate names; to help resolve conflicts</span>
        <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dro</span><span class="p">])</span>
        <span class="c1"># then allow tab completion of all delegate methods</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dro</span><span class="p">):</span>
            <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="c1"># do not allow setting of properties of the delegate classes</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dro</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;the Cosmology object is immutable; use clone() or &quot;</span>
                              <span class="s2">&quot;match() to update parameters&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the proper delegate, initialize it, and run the method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># getting a delegate explicitly, e.g. c.Background</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dro_dict</span><span class="p">:</span>
            <span class="n">iface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dro_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">iface</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">iface</span><span class="p">]</span> <span class="o">=</span> <span class="n">iface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">iface</span><span class="p">]</span>

        <span class="c1"># resolving a name from the delegates : c.Om0 =&gt; c.Background.Om0</span>
        <span class="k">for</span> <span class="n">iface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dro</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iface</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">iface</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">iface</span><span class="p">]</span> <span class="o">=</span> <span class="n">iface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">iface</span><span class="p">]</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` not found in any of the delegate objects&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sigma8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The amplitude of matter fluctuations at :math:`z=0` in a sphere</span>
<span class="sd">        of radius :math:`r = 8 \ h^{-1}\mathrm{Mpc}`.</span>

<span class="sd">        This is not an input CLASS parameter. To scale ``sigma8``, use</span>
<span class="sd">        :func:`match`, which adjusts scalar amplitude ``A_s`` to</span>
<span class="sd">        achieve the desired ``sigma8``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spectra</span><span class="o">.</span><span class="n">sigma8</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Omega0_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total density of CDM and Baryon.</span>

<span class="sd">        This is not an input CLASS parameter. To scale ``Omega0_cb``, use</span>
<span class="sd">        :func:`match`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Background</span><span class="o">.</span><span class="n">Omega0_cdm</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Background</span><span class="o">.</span><span class="n">Omega0_b</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma8</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Omega0_cb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Omega0_m</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new cosmology that matches a derived parameter. This is different</span>
<span class="sd">        from clone, where CLASS parameters are used.</span>

<span class="sd">        Note that we only supoort matching one derived parameter at a time,</span>
<span class="sd">        because the matching is in general non-commutable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sigma8 : float or None</span>
<span class="sd">            We scale the scalar amplitude ``A_s`` to achieve the desired ``sigma8``.</span>
<span class="sd">        Omega0_cb: float or None</span>
<span class="sd">            Desired total energy density of CDM and baryon.</span>
<span class="sd">        Omega0_m: float or None</span>
<span class="sd">            Desired total energy density of matter-like components (included ncdm)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A new cosmology parameter where the derived parameter matches the given constrain.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sigma8</span><span class="p">,</span> <span class="n">Omega0_cb</span><span class="p">,</span> <span class="n">Omega0_m</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only match one derived parameter at one time; but multiple is given.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigma8</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">A_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma8</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma8</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Omega0_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rat</span> <span class="o">=</span> <span class="n">Omega0_cb</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega0_cb</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">Omega_b</span><span class="o">=</span><span class="n">rat</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega0_b</span><span class="p">,</span> <span class="n">Omega_cdm</span><span class="o">=</span><span class="n">rat</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega0_cdm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Omega0_m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Omega0_cb</span> <span class="o">=</span> <span class="n">Omega0_m</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Omega0_ncdm_tot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega0_pncdm_tot</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega0_dcdm</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Omega0_cb</span><span class="o">=</span><span class="n">Omega0_cb</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">to_astropy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize and return a subclass of :class:`astropy.cosmology.FLRW`</span>
<span class="sd">        from the :class:`Cosmology` class.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        subclass of :class:`astropy.cosmology.FLRW` :</span>
<span class="sd">            the astropy class holding the cosmology values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">astropy.cosmology</span> <span class="k">as</span> <span class="nn">ac</span>
        <span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">au</span>

        <span class="n">is_flat</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">needs_w0</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">needs_wa</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Om0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega0_b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega0_cdm</span> <span class="c1"># exclude massive neutrinos to better match astropy</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Tcmb0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tcmb0</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Neff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Neff</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Ob0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ob0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_massive_nu</span><span class="p">:</span>

            <span class="c1"># all massless by default</span>
            <span class="n">m_nu</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Neff</span><span class="p">)))</span>

            <span class="c1"># then add massive species</span>
            <span class="n">m_nu</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_ncdm</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_ncdm</span><span class="p">[:]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;m_nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">m_nu</span><span class="p">,</span> <span class="n">au</span><span class="o">.</span><span class="n">eV</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ok0</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Ode0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ode0</span>
            <span class="n">is_flat</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_fld</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_fld</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa_fld</span>
            <span class="n">needs_wa</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">w0_fld</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w0_fld</span>
            <span class="n">needs_w0</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># determine class to return</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_flat</span> <span class="k">else</span> <span class="s2">&quot;Flat&quot;</span>
        <span class="k">if</span> <span class="n">needs_wa</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;w0waCDM&quot;</span>
        <span class="k">elif</span> <span class="n">needs_w0</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;wCDM&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;LambdaCDM&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">pars</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_astropy</span><span class="p">(</span><span class="n">kls</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize and return a :class:`Cosmology` object from a subclass of</span>
<span class="sd">        :class:`astropy.cosmology.FLRW`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cosmo : subclass of :class:`astropy.cosmology.FLRW`.</span>
<span class="sd">            the astropy cosmology instance</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            extra keyword parameters to pass when initializing;</span>
<span class="sd">            they shall not be in conflict with the parameters</span>
<span class="sd">            inferred from cosmo. To override parameters,</span>
<span class="sd">            chain the result with :func:`clone`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`Cosmology` :</span>
<span class="sd">            the initialized cosmology object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">astropy_to_dict</span><span class="p">(</span><span class="n">cosmo</span><span class="p">)</span>
        <span class="c1"># merge in additional arguments -- this will die if</span>
        <span class="c1"># there are conflicts.</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># astropy_to_dict creates args, so we can use the &#39;user-friendly&#39;</span>
        <span class="c1"># constructor.</span>
        <span class="k">return</span> <span class="n">Cosmology</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a :class:`Cosmology` object from the CLASS parameter file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            the name of the parameter file to read</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            extra keyword parameters to pass when initializing;</span>
<span class="sd">            they shall not be in conflict with the parameters</span>
<span class="sd">            inferred from cosmo. To override parameters,</span>
<span class="sd">            chain the result with :func:`clone`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">classylss</span> <span class="kn">import</span> <span class="n">load_ini</span>

        <span class="c1"># extract dictionary of parameters from the file</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">load_ini</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># intentionally not using merge; use clone if</span>
        <span class="c1"># parameters are to modified.</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">kls</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Cosmology from a pars dictionary.</span>

<span class="sd">        This is a rather &#39;raw&#39; API.</span>
<span class="sd">        The dictionary must be readable by ClassEngine.</span>
<span class="sd">        Unlike ``Cosmology(**args)``, ``pars`` must</span>
<span class="sd">        not contain any convenient names defined here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Cosmology</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>

        <span class="n">pars</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># initialize the engine as the backup delegate.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">ClassEngine</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegates</span> <span class="o">=</span> <span class="p">{</span><span class="n">ClassEngine</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">pars</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new cosmology based on modification of self, with the</span>
<span class="sd">        input keyword parameters changed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            keyword parameters to adjust</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`Cosmology`</span>
<span class="sd">            a copy of self, with the input ``kwargs`` adjusted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this call to merge_args is OK because self.pars is</span>
        <span class="c1"># a valid set of args</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">merge_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">check_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">compile_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">astropy_to_dict</span><span class="p">(</span><span class="n">cosmo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an astropy cosmology object to a dictionary of parameters</span>
<span class="sd">    suitable for initializing a Cosmology object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">cosmology</span><span class="p">,</span> <span class="n">units</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">h</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;T0_cmb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Tcmb0</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Ob0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;Omega0_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Ob0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;please specify a value &#39;Ob0&#39; &quot;</span><span class="p">)</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;Omega0_cdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Om0</span> <span class="o">-</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Ob0</span> <span class="c1"># should be okay for now</span>

    <span class="c1"># handle massive neutrinos</span>
    <span class="k">if</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">has_massive_nu</span><span class="p">:</span>

        <span class="c1"># convert to eV</span>
        <span class="n">m_nu</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">m_nu</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m_nu</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m_nu</span><span class="o">.</span><span class="n">unit</span> <span class="o">!=</span> <span class="n">units</span><span class="o">.</span><span class="n">eV</span><span class="p">:</span>
            <span class="n">m_nu</span> <span class="o">=</span> <span class="n">m_nu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">eV</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m_nu</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">eV</span> <span class="o">*</span> <span class="n">m_nu</span>
        <span class="c1"># from CLASS notes:</span>
        <span class="c1"># one more remark: if you have respectively 1,2,3 massive neutrinos,</span>
        <span class="c1"># if you stick to the default value pm equal to 0.71611, designed to give m/omega of</span>
        <span class="c1"># 93.14 eV, and if you want to use N_ur to get N_eff equal to 3.046 in the early universe,</span>
        <span class="c1"># then you should pass here respectively 2.0328,1.0196,0.00641</span>
        <span class="n">N_ur</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0328</span><span class="p">,</span> <span class="mf">1.0196</span><span class="p">,</span> <span class="mf">0.00641</span><span class="p">]</span>
        <span class="n">N_massive</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_nu</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;N_ur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">Neff</span><span class="o">/</span><span class="mf">3.046</span><span class="p">)</span> <span class="o">*</span> <span class="n">N_ur</span><span class="p">[</span><span class="n">N_massive</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;m_ncdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">m_nu</span><span class="p">[</span><span class="n">m_nu</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;m_ncdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;N_ur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Neff</span>

    <span class="c1"># specify the curvature</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;Omega0_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Ok0</span>

    <span class="c1"># handle dark energy</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">LambdaCDM</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">wCDM</span><span class="p">):</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;w0_fld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">w0</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;wa_fld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;Omega0_Lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># use Omega_fld</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">w0waCDM</span><span class="p">):</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;w0_fld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">w0</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;wa_fld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">wa</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;Omega0_Lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># use Omega_fld</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LambdaCDM&quot;</span><span class="p">,</span> <span class="s2">&quot;wCDM&quot;</span><span class="p">,</span> <span class="s2">&quot;w0waCDM&quot;</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dark energy equation of state not recognized for class &#39;</span><span class="si">%s</span><span class="s2">&#39;; &quot;</span> <span class="o">%</span><span class="bp">cls</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;valid classes: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">compile_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compile the input args of Cosmology object to the input parameters (pars) to</span>
<span class="sd">    a :class:`Cosmology` object.</span>

<span class="sd">    A variety of defaults are set to tune CLASS for quantities used in</span>
<span class="sd">    large scale structures.</span>

<span class="sd">    Difference between pars and args:</span>
<span class="sd">     - anything that is valid pars is also valid args.</span>
<span class="sd">     - after replacing our customizations in args, we get pars.</span>

<span class="sd">    Note that CLASS will check for additional conflicts.</span>

<span class="sd">    see :func:`merge_args`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># we try to make pars write only.</span>

    <span class="c1"># set some default parameters</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s2">&quot;vTk dTk mPk&quot;</span><span class="p">)</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;extra metric transfer functions&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="c1"># args and pars are pretty much compatible;</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_alias</span><span class="p">(</span><span class="n">pars_name</span><span class="p">,</span> <span class="n">args_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">args_name</span><span class="p">]</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">args_name</span><span class="p">)</span> <span class="c1"># pop because we copied everything.</span>
        <span class="k">if</span> <span class="n">pars_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">pars_name</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="n">pars_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;T_cmb&#39;</span><span class="p">,</span> <span class="s1">&#39;T0_cmb&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_cdm&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_cdm&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_b&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_b&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_k&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_k&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_ur&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_ur&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega_lambda&#39;</span><span class="p">)</span> <span class="c1"># classylss variable has lowercase l</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_lambda&#39;</span><span class="p">)</span> <span class="c1"># classylss variable has lowercase l</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_Lambda&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_fld&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_fld&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_ncdm&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_ncdm&#39;</span><span class="p">)</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;Omega_g&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_g&#39;</span><span class="p">)</span>

    <span class="c1"># turn on verbosity</span>
    <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;thermodynamics&#39;</span><span class="p">,</span> <span class="s1">&#39;perturbations&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;transfer&#39;</span><span class="p">,</span> <span class="s1">&#39;primordial&#39;</span><span class="p">,</span> <span class="s1">&#39;spectra&#39;</span><span class="p">,</span> <span class="s1">&#39;nonlinear&#39;</span><span class="p">,</span> <span class="s1">&#39;lensing&#39;</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">par</span> <span class="o">+</span> <span class="s1">&#39;_verbose&#39;</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span> <span class="n">pars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># no massive neutrinos</span>
    <span class="k">if</span> <span class="s1">&#39;m_ncdm&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;m_ncdm&#39;</span><span class="p">)</span>
        <span class="n">m_ncdm</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;m_ncdm&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m_ncdm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m_ncdm</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">m_ncdm</span><span class="p">):</span>
            <span class="c1"># a single massive neutrino</span>
            <span class="n">m_ncdm</span> <span class="o">=</span> <span class="p">[</span><span class="n">m_ncdm</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m_ncdm</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">m_ncdm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">m_ncdm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;``m_ncdm`` should be a list of mass values in eV&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">m_ncdm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A zero mass is specified in the non-cold dark matter list. &quot;</span>
                                 <span class="s2">&quot;This is not needed, as we automatically set N_ur based on &quot;</span>
                                 <span class="s2">&quot;the number of entries in m_ncdm such that Neff = 3.046.&quot;</span><span class="p">)</span>

        <span class="c1"># number of massive neutrino species</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;N_ncdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_ncdm</span><span class="p">)</span>

        <span class="c1"># m_ncdm only needed if we have massive neutrinos</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_ncdm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;m_ncdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_ncdm</span>

        <span class="c1"># from CLASS notes:</span>
        <span class="c1"># one more remark: if you have respectively 1,2,3 massive neutrinos,</span>
        <span class="c1"># if you stick to the default value pm equal to 0.71611, designed to give m/omega of</span>
        <span class="c1"># 93.14 eV, and if you want to use N_ur to get N_eff equal to 3.046 in the early universe,</span>
        <span class="c1"># then you should pass here respectively 2.0328,1.0196,0.00641</span>
        <span class="n">N_ur_table</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.046</span><span class="p">,</span> <span class="mf">2.0328</span><span class="p">,</span> <span class="mf">1.0196</span><span class="p">,</span> <span class="mf">0.00641</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;N_ur&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;N_ur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_ur_table</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">m_ncdm</span><span class="p">)]</span>

    <span class="k">if</span> <span class="s1">&#39;N_ur&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;N_ur&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;N_ur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;N_ur&#39;</span><span class="p">]</span>

    <span class="c1"># check gauge</span>
    <span class="k">if</span> <span class="s1">&#39;gauge&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;gauge&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;synchronous&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonian&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;gauge&#39; should be &#39;synchronous&#39; or &#39;newtonian&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># set cosmological constant to zero if we got fluid w0/wa</span>
    <span class="k">if</span> <span class="s1">&#39;w0_fld&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">or</span> <span class="s1">&#39;wa_fld&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;non-zero Omega_Lambda (cosmological constant) specified as &quot;</span>
                             <span class="s2">&quot;well as fluid w0/wa; use Omega_fld instead&quot;</span><span class="p">))</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>


    <span class="c1"># maximum k value</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;P_k_max_h/Mpc&#39;</span><span class="p">,</span> <span class="s1">&#39;P_k_max&#39;</span><span class="p">)</span>

    <span class="c1"># maximum redshift</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;z_max_pk&#39;</span><span class="p">,</span> <span class="s1">&#39;P_z_max&#39;</span><span class="p">)</span>

    <span class="c1"># nonlinear</span>
    <span class="n">set_alias</span><span class="p">(</span><span class="s1">&#39;non linear&#39;</span><span class="p">,</span> <span class="s1">&#39;nonlinear&#39;</span><span class="p">)</span>
    <span class="c1"># sorry we use a boolean but</span>
    <span class="c1"># class uses existence of string.</span>
    <span class="k">if</span> <span class="n">pars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;non linear&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;non linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;halofit&#39;</span>

    <span class="c1"># remove None&#39;s for remaining parameters -- None means using a default from CLASS</span>
    <span class="c1"># NOTE: do this last since m_ncdm=None means no massive_neutrinos</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pars</span>


<span class="k">def</span> <span class="nf">merge_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">moreargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    merge moreargs into args.</span>

<span class="sd">    Those defined in moreargs takes priority than those</span>
<span class="sd">    defined in args.</span>

<span class="sd">    see :func:`compile_args`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">moreargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># pop those conflicting with me from the old pars</span>
        <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">find_eqcls</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">moreargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">check_deprecated_init</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if ``kwargs`` uses the (now deprecated) signature of ``Cosmology``</span>
<span class="sd">    prior to version 0.2.6.</span>

<span class="sd">    If using the deprecated syntax, this returns the necessary arguments for</span>
<span class="sd">    the new signature, and ``None`` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">cosmology</span><span class="p">,</span> <span class="n">units</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H0&#39;</span><span class="p">:</span><span class="mf">67.6</span><span class="p">,</span> <span class="s1">&#39;Om0&#39;</span><span class="p">:</span><span class="mf">0.31</span><span class="p">,</span> <span class="s1">&#39;Ob0&#39;</span><span class="p">:</span><span class="mf">0.0486</span><span class="p">,</span> <span class="s1">&#39;Ode0&#39;</span><span class="p">:</span><span class="mf">0.69</span><span class="p">,</span> <span class="s1">&#39;w0&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
                <span class="s1">&#39;Tcmb0&#39;</span><span class="p">:</span><span class="mf">2.7255</span><span class="p">,</span> <span class="s1">&#39;Neff&#39;</span><span class="p">:</span><span class="mf">3.04</span><span class="p">,</span> <span class="s1">&#39;m_nu&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;flat&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>

    <span class="c1"># the deprecated kwargs</span>
    <span class="n">deprecated_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">]</span>

    <span class="c1"># all clear; nothing to do</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">deprecated_args</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># if we got deprecated kwargs, make sure we didn&#39;t get any valid kwargs!!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">defaults</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;mixing deprecated and valid arguments for the Cosmology class; &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;the following args are deprecated: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">deprecated_args</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># update old defaults with input params</span>
    <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;m_nu&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;m_nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;m_nu&#39;</span><span class="p">],</span> <span class="s1">&#39;eV&#39;</span><span class="p">)</span>

    <span class="c1"># determine the astropy class</span>
    <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;w0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span> <span class="c1"># cosmological constant</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="s1">&#39;LambdaCDM&#39;</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;w0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="s1">&#39;wCDM&#39;</span>

    <span class="c1"># use special flat case if Ok0 = 0</span>
    <span class="k">if</span> <span class="n">defaults</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;flat&#39;</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="s1">&#39;Flat&#39;</span> <span class="o">+</span> <span class="bp">cls</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Ode0&#39;</span><span class="p">)</span>

    <span class="c1"># initialize the astropy engine and convert to dict for Cosmology()</span>
    <span class="n">astropy_cosmo</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">astropy_to_dict</span><span class="p">(</span><span class="n">astropy_cosmo</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">cf</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">find_eqcls</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">eq</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="n">cf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Conflicted parameters are given: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span>

<span class="c1"># dict that defines input parameters that conflict with each other</span>
<span class="n">CONFLICTS</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;H0&#39;</span><span class="p">,</span> <span class="s1">&#39;100*theta_s&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;T_cmb&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega_g&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_g&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_g&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;Omega_b&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_b&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_b&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;Omega_fld&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_fld&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_Lambda&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;N_ur&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega_ur&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_ur&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_ur&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;Omega_cdm&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_cdm&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_cdm&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;m_ncdm&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega_ncdm&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_ncdm&#39;</span><span class="p">,</span> <span class="s1">&#39;Omega0_ncdm&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;P_k_max&#39;</span><span class="p">,</span> <span class="s1">&#39;P_k_max_h/Mpc&#39;</span><span class="p">,</span> <span class="s1">&#39;P_k_max_1/Mpc&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;P_z_max&#39;</span><span class="p">,</span> <span class="s1">&#39;z_max_pk&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">,</span> <span class="s1">&#39;non linear&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;A_s&#39;</span><span class="p">,</span> <span class="s1">&#39;ln10^</span><span class="si">{10}</span><span class="s1">A_s&#39;</span><span class="p">),</span>
            <span class="p">]</span>

<span class="k">def</span> <span class="nf">find_eqcls</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">CONFLICTS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy; Copyright 2020, Mike Shengbo Wang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>