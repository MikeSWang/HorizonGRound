
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>horizonground.clustering_modification &#8212; HorizonGRound 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/HorizonGRound.png" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick_recipes.html">Quick Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc.html">API Reference</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for horizonground.clustering_modification</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Clustering modification (:mod:`~horizonground.clustering_modification`)</span>
<span class="sd">===========================================================================</span>

<span class="sd">Compute modifications to the Newtonian power spectrum in the</span>
<span class="sd">distant-observer and plane-parallel limits.</span>


<span class="sd">Standard Kaiser RSD model</span>
<span class="sd">---------------------------------------------------------------------------</span>

<span class="sd">Redshift-space distortions induce anisotropy in the power spectrum</span>
<span class="sd">multipoles</span>

<span class="sd">.. math::</span>

<span class="sd">    \begin{align*}</span>
<span class="sd">        P_0(k, z) &amp;=</span>
<span class="sd">            \left[</span>
<span class="sd">                b_1(z)^2 + \frac{2}{3} b_1(z) f(z) + \frac{1}{5} f(z)^2</span>
<span class="sd">            \right] P_\mathrm{m}(k, z) \,, \\</span>
<span class="sd">        P_2(k, z) &amp;=</span>
<span class="sd">            \left[</span>
<span class="sd">                \frac{4}{3} b_1(z) f(z) + \frac{4}{7} f(z)^2</span>
<span class="sd">            \right] P_\mathrm{m}(k, z) \,, \\</span>
<span class="sd">        P_4(k, z) &amp;= \frac{8}{35} f(z)^2 P_\mathrm{m}(k, z) \,</span>
<span class="sd">    \end{align*}</span>

<span class="sd">where :math:`P_\mathrm{m}` is the matter power spectrum, :math:`b_1(z)` is</span>
<span class="sd">the linear bias and :math:`f(z)` is the linear growth rate.</span>

<span class="sd">.. autosummary::</span>

<span class="sd">    standard_kaiser_factor</span>


<span class="sd">Non-Gaussianity scale-dependent modifications</span>
<span class="sd">---------------------------------------------------------------------------</span>

<span class="sd">Local primordial non-Gaussianty :math:`f_\mathrm{NL}` induces scale</span>
<span class="sd">dependence in the linear bias,</span>

<span class="sd">.. math::</span>

<span class="sd">    b_1(z) \mapsto b_1(z) + \Delta b_k(z) \,, \quad</span>
<span class="sd">    \Delta b(k, z) = f_\mathrm{NL} [b_1(z) - p] \frac{A(k, z)}{k^2} \,,</span>

<span class="sd">where the scale-dependence kernel is</span>

<span class="sd">.. math::</span>

<span class="sd">    A(k, z) = 3 \left( \frac{H_0}{\mathrm{c}} \right)^2</span>
<span class="sd">        \frac{1.27 \varOmega_\mathrm{m,0} \delta_\mathrm{c}}{D(z)T(k)} \,.</span>

<span class="sd">Here :math:`H_0` is the Hubble parameter at the current epoch</span>
<span class="sd">(in km/s/Mpc), :math:`\mathrm{c}` the speed of light,</span>
<span class="sd">:math:`\varOmega_\mathrm{m,0}` the matter density parameter at the current</span>
<span class="sd">epoch, and :math:`\delta_\mathrm{c}` the critical over-density in</span>
<span class="sd">spherical gravitational collapse.  The growth factor :math:`D(z)` is</span>
<span class="sd">normalised to unity at the current epoch (thus the numerical factor 1.27),</span>
<span class="sd">the transfer function :math:`T(k)` is normalised to unity as</span>
<span class="sd">:math:`k \to 0`, and :math:`p` is a tracer-dependent parameter.</span>

<span class="sd">Modifications to power spectrum multipoles as a result of local primordial</span>
<span class="sd">non-Gaussianty are</span>

<span class="sd">.. math::</span>

<span class="sd">    \begin{align*}</span>
<span class="sd">        \Delta P_0(k, z) &amp;= \left[</span>
<span class="sd">            \left( 2 b_1 + \frac{2}{3} f \right) \Delta b(k, z)</span>
<span class="sd">            + \Delta b(k, z)^2</span>
<span class="sd">        \right] P_\mathrm{m}(k, z) \,, \\</span>
<span class="sd">        \Delta P_2(k, z) &amp;=</span>
<span class="sd">            \frac{4}{3} f \Delta b(k, z) P_\mathrm{m}(k, z) \,.</span>
<span class="sd">    \end{align*}</span>

<span class="sd">.. autosummary::</span>

<span class="sd">    scale_dependence_kernel</span>
<span class="sd">    non_gaussianity_correction_factor</span>


<span class="sd">Relativistic corrections</span>
<span class="sd">---------------------------------------------------------------------------</span>

<span class="sd">Relativistic corrections to the Newtonian clustering mode</span>

<span class="sd">.. math::</span>

<span class="sd">    \delta(\mathbf{k}, z)</span>
<span class="sd">    = b_1(z) \delta_\mathrm{m}(\mathbf{k}, z)</span>
<span class="sd">        + g(z) v_{\parallel}(\mathbf{k}, z)</span>
<span class="sd">    = b_1(z) \delta_\mathrm{m}(\mathbf{k}, z)</span>
<span class="sd">        + \mathrm{i} \frac{\mathcal{H}}{k} g(z) f(z) \mu</span>
<span class="sd">        \delta_\mathrm{m}(\mathbf{k}, z)</span>

<span class="sd">are parametrised by the redshift-dependent, dimensionless quantity</span>

<span class="sd">.. math::</span>

<span class="sd">    g(z) = \frac{\mathcal{H}&#39;}{\mathcal{H}^2}</span>
<span class="sd">        + 5s + \frac{2 - 5s}{\mathcal{H} \chi}</span>
<span class="sd">        - b_\mathrm{e}</span>

<span class="sd">with evolution bias :math:`b_\mathrm{e}(z)` and magnification bias</span>
<span class="sd">:math:`s(z)`, where :math:`v_{\parallel}` is the line-of-sight peculiar</span>
<span class="sd">velocity, :math:`\chi(z)` is the comoving distance and :math:`&#39;` denotes</span>
<span class="sd">derivatives with respect to the conformal time. This can be written as the</span>
<span class="sd">sum of three contributions</span>

<span class="sd">.. math::</span>

<span class="sd">    g(z) = \underbrace{\left[</span>
<span class="sd">        1</span>
<span class="sd">        - \frac{3}{2} \frac{H_0^2}{H(z)^2} \varOmega_\mathrm{m,0} (1 + z)^3</span>
<span class="sd">        + \frac{2}{\mathcal{H}\chi}</span>
<span class="sd">    \right]}_{\text{background expansion}}</span>
<span class="sd">    \underbrace{- b_\mathrm{e}(z)}_{\text{evolution}}</span>
<span class="sd">    + \underbrace{</span>
<span class="sd">        5s(z) \left( 1 - \frac{1}{\mathcal{H}\chi} \right)</span>
<span class="sd">    }_{\text{magnification}} \,.</span>

<span class="sd">Modifications to power spectrum multipoles from the relativistic</span>
<span class="sd">corrections are</span>

<span class="sd">.. math::</span>

<span class="sd">    \begin{align*}</span>
<span class="sd">        \Delta P_0(k, z) &amp;= \frac{1}{3} \frac{\mathcal{H}^2}{k^2}</span>
<span class="sd">            g(z)^2 f(z)^2 P_\mathrm{m}(k,z) \,,\\</span>
<span class="sd">        \Delta P_2(k, z) &amp;= \frac{2}{3} \frac{\mathcal{H}^2}{k^2}</span>
<span class="sd">            g(z)^2 f(z)^2 P_\mathrm{m}(k,z) \,,</span>
<span class="sd">    \end{align*}</span>

<span class="sd">.. autosummary::</span>

<span class="sd">    relativistic_correction_func</span>
<span class="sd">    relativistic_correction_value</span>
<span class="sd">    relativistic_correction_factor</span>

<span class="sd">|</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=no-name-in-module</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.constants</span> <span class="kn">import</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">nbodykit.lab</span> <span class="kn">import</span> <span class="n">cosmology</span> <span class="k">as</span> <span class="n">nbk_cosmology</span>

<span class="n">_SPEED_OF_LIGHT_IN_KM_PER_S</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
<span class="n">_SPHERICAL_COLLAPSE_CRITICAL_OVERDENSITY</span> <span class="o">=</span> <span class="mf">1.686</span>
<span class="n">_GROWTH_FACTOR_NORMALISATION</span> <span class="o">=</span> <span class="mf">1.27</span>

<span class="n">FIDUCIAL_COSMOLOGY</span> <span class="o">=</span> <span class="n">nbk_cosmology</span><span class="o">.</span><span class="n">Planck15</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;:class:`nbodykit.cosmology.Cosmology`: Default Planck15 cosmology.</span>

<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="standard_kaiser_factor"><a class="viewcode-back" href="../../horizonground.clustering_modification.html#horizonground.clustering_modification.standard_kaiser_factor">[docs]</a><span class="k">def</span> <span class="nf">standard_kaiser_factor</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">=</span><span class="n">FIDUCIAL_COSMOLOGY</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute the standard Kaiser power spectrum multipoles as multiples</span>
<span class="sd">    of the matter power spectrum, i.e. :math:`P_\ell/P_\mathrm{m}`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    order : int</span>
<span class="sd">        Order of the multipole, ``order &gt;= 0``.</span>
<span class="sd">    bias : float</span>
<span class="sd">        Scale-independent linear bias at `redshift`.</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Redshift.</span>
<span class="sd">    cosmo : :class:`nbodykit.cosmology.Cosmology`, optional</span>
<span class="sd">        Cosmological model (default is ``FIDUCIAL_COSMOLOGY``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    factor : float</span>
<span class="sd">        Power spectrum multipoles as multiples of the matter power</span>
<span class="sd">        spectrum.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b_1</span> <span class="o">=</span> <span class="n">bias</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">scale_independent_growth_rate</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">b_1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">b_1</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">b_1</span> <span class="o">+</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">7.</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">8.</span><span class="o">/</span><span class="mf">35.</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">factor</span></div>


<div class="viewcode-block" id="scale_dependence_kernel"><a class="viewcode-back" href="../../horizonground.clustering_modification.html#horizonground.clustering_modification.scale_dependence_kernel">[docs]</a><span class="k">def</span> <span class="nf">scale_dependence_kernel</span><span class="p">(</span><span class="n">redshift</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">=</span><span class="n">FIDUCIAL_COSMOLOGY</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the scale-dependence kernel :math:`A(k, z)` in the presence</span>
<span class="sd">    of local primordial non-Gaussianity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Redshift.</span>
<span class="sd">    cosmo : :class:`nbodykit.cosmology.Cosmology`, optional</span>
<span class="sd">        Cosmological model (default is ``FIDUCIAL_COSMOLOGY``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable</span>
<span class="sd">        Scale-dependence kernel as a function of wavenumber (in</span>
<span class="sd">        :math:`h/\mathrm{Mpc}`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numerical_constants</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">_SPHERICAL_COLLAPSE_CRITICAL_OVERDENSITY</span> \
        <span class="o">*</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">Om0</span> <span class="o">*</span> <span class="n">_GROWTH_FACTOR_NORMALISATION</span> \
        <span class="o">*</span> <span class="p">(</span><span class="n">FIDUCIAL_COSMOLOGY</span><span class="o">.</span><span class="n">H0</span> <span class="o">/</span> <span class="n">_SPEED_OF_LIGHT_IN_KM_PER_S</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">transfer_function</span> <span class="o">=</span> <span class="n">nbk_cosmology</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">transfers</span><span class="o">.</span><span class="n">CLASS</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">redshift</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">numerical_constants</span> <span class="o">/</span> <span class="n">transfer_function</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>


<div class="viewcode-block" id="non_gaussianity_correction_factor"><a class="viewcode-back" href="../../horizonground.clustering_modification.html#horizonground.clustering_modification.non_gaussianity_correction_factor">[docs]</a><span class="k">def</span> <span class="nf">non_gaussianity_correction_factor</span><span class="p">(</span><span class="n">wavenumber</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">local_png</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span>
                                      <span class="n">redshift</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">=</span><span class="n">FIDUCIAL_COSMOLOGY</span><span class="p">,</span>
                                      <span class="n">tracer_p</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute modifications to the power spectrum multipoles by local</span>
<span class="sd">    primordial non-Gaussianity as multiples of the matter power spectrum,</span>
<span class="sd">    i.e. :math:`\Delta P_\ell/P_\mathrm{m}`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavenumber : float, array_like</span>
<span class="sd">        Wavenumber (in :math:`h/\mathrm{Mpc}`).</span>
<span class="sd">    order : int</span>
<span class="sd">        Order of the multipole, ``order &gt;= 0``.</span>
<span class="sd">    local_png : float</span>
<span class="sd">        Local primordial non-Gaussianity.</span>
<span class="sd">    bias : float</span>
<span class="sd">        Scale-independent linear bias at `redshift`.</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Redshift.</span>
<span class="sd">    cosmo : :class:`nbodykit.cosmology.Cosmology`, optional</span>
<span class="sd">        Base cosmological model (default is ``FIDUCIAL_COSMOLOGY``).</span>
<span class="sd">    tracer_p : float, optional</span>
<span class="sd">        Tracer parameter (default is 1.).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    factor : float :class:`numpy.ndarray`</span>
<span class="sd">        Power spectrum multipole modifications as multiples of the matter</span>
<span class="sd">        power spectrum.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f_nl</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">local_png</span><span class="p">,</span> <span class="n">tracer_p</span>
    <span class="n">b_1</span> <span class="o">=</span> <span class="n">bias</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span> <span class="k">else</span> <span class="n">bias</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">scale_independent_growth_rate</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

    <span class="n">delta_b</span> <span class="o">=</span> <span class="n">f_nl</span> <span class="o">*</span> <span class="p">(</span><span class="n">b_1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> \
        <span class="o">*</span> <span class="n">scale_dependence_kernel</span><span class="p">(</span><span class="n">redshift</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">)(</span><span class="n">wavenumber</span><span class="p">)</span> \
        <span class="o">/</span> <span class="n">wavenumber</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_1</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_b</span> <span class="o">+</span> <span class="n">delta_b</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">delta_b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">factor</span></div>


<div class="viewcode-block" id="relativistic_correction_func"><a class="viewcode-back" href="../../horizonground.clustering_modification.html#horizonground.clustering_modification.relativistic_correction_func">[docs]</a><span class="k">def</span> <span class="nf">relativistic_correction_func</span><span class="p">(</span><span class="n">cosmo</span><span class="o">=</span><span class="n">FIDUCIAL_COSMOLOGY</span><span class="p">,</span> <span class="n">geometric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">evolution_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">magnification_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the relativistic correction function as</span>
<span class="sd">    :math:`\mathcal{H} g(z)`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cosmo : :class:`nbodykit.cosmology.Cosmology`, optional</span>
<span class="sd">        Cosmological model (default is ``FIDUCIAL_COSMOLOGY``).</span>
<span class="sd">    geometric : bool, optional</span>
<span class="sd">        If `True` (default), include geometric contributions from the</span>
<span class="sd">        background expansion.</span>
<span class="sd">    evolution_bias, magnification_bias : callable or None, optional</span>
<span class="sd">        Evolution bias or magnification bias as a function of redshift</span>
<span class="sd">        (default is `None`).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable</span>
<span class="sd">        Relativistic correction function as a function of redshift</span>
<span class="sd">        (in :math:`h`/Mpc).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">astropy_cosmo</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">to_astropy</span><span class="p">()</span>

    <span class="n">aH</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> \
        <span class="o">*</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">_SPEED_OF_LIGHT_IN_KM_PER_S</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">comoving_distance</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="k">if</span> <span class="n">geometric</span><span class="p">:</span>
        <span class="n">geometric_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> \
            <span class="mi">1</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">Om0</span> \
            <span class="o">*</span> <span class="p">(</span><span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">H0</span> <span class="o">/</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">z</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> \
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geometric_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="mf">0.</span>

    <span class="k">if</span> <span class="n">evolution_bias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">evolution_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">evolution_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">aH</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi</span><span class="p">(</span><span class="n">z</span><span class="p">))</span> <span class="o">-</span> <span class="n">evolution_bias</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">magnification_bias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lensing_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lensing_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> \
            <span class="mi">5</span> <span class="o">*</span> <span class="n">magnification_bias</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">aH</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">aH</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">h</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">geometric_term</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">evolution_term</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">lensing_term</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="relativistic_correction_value"><a class="viewcode-back" href="../../horizonground.clustering_modification.html#horizonground.clustering_modification.relativistic_correction_value">[docs]</a><span class="k">def</span> <span class="nf">relativistic_correction_value</span><span class="p">(</span><span class="n">redshift</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">=</span><span class="n">FIDUCIAL_COSMOLOGY</span><span class="p">,</span>
                                  <span class="n">geometric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">evolution_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">magnification_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Evaluate the relativistic correction function</span>
<span class="sd">    :math:`\mathcal{H} g(z)` at a given redshift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Redshift.</span>
<span class="sd">    cosmo : :class:`nbodykit.cosmology.Cosmology`, optional</span>
<span class="sd">        Base cosmological model (default is ``FIDUCIAL_COSMOLOGY``).</span>
<span class="sd">    geometric : bool, optional</span>
<span class="sd">        If `True` (default), include geometric contributions from the</span>
<span class="sd">        background expansion.</span>
<span class="sd">    evolution_bias, magnification_bias : float or None, optional</span>
<span class="sd">        Evolution bias or magnification bias evaluated at input `redshift`</span>
<span class="sd">        (default is `None`).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    correction_value : float</span>
<span class="sd">        Relativistic correction function value (in :math:`h`/Mpc)</span>
<span class="sd">        at `redshift`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">astropy_cosmo</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">to_astropy</span><span class="p">()</span>

    <span class="n">aH</span> <span class="o">=</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span> \
        <span class="o">*</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">_SPEED_OF_LIGHT_IN_KM_PER_S</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">comoving_distance</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="n">correction_value</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">geometric</span><span class="p">:</span>
        <span class="n">correction_value</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">Om0</span> \
            <span class="o">*</span> <span class="p">(</span><span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">H0</span> <span class="o">/</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">redshift</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> \
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="n">evolution_bias</span><span class="p">:</span>
        <span class="n">correction_value</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">aH</span> <span class="o">*</span> <span class="n">chi</span><span class="p">)</span> <span class="o">-</span> <span class="n">evolution_bias</span>
    <span class="k">if</span> <span class="n">magnification_bias</span><span class="p">:</span>
        <span class="n">correction_value</span> <span class="o">+=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">magnification_bias</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">aH</span> <span class="o">*</span> <span class="n">chi</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">aH</span> <span class="o">/</span> <span class="n">astropy_cosmo</span><span class="o">.</span><span class="n">h</span>  <span class="o">*</span> <span class="n">correction_value</span></div>


<div class="viewcode-block" id="relativistic_correction_factor"><a class="viewcode-back" href="../../horizonground.clustering_modification.html#horizonground.clustering_modification.relativistic_correction_factor">[docs]</a><span class="k">def</span> <span class="nf">relativistic_correction_factor</span><span class="p">(</span><span class="n">wavenumber</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span>
                                   <span class="n">correction_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">cosmo</span><span class="o">=</span><span class="n">FIDUCIAL_COSMOLOGY</span><span class="p">,</span>
                                   <span class="n">geometric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">evolution_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">magnification_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute modifications to the power spectrum multipoles by</span>
<span class="sd">    relativistic corrections as multiples of the matter power spectrum,</span>
<span class="sd">    i.e. :math:`\Delta P_\ell/P_\mathrm{m}`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavenumber : float, array_like</span>
<span class="sd">        Wavenumber (in :math:`h/\mathrm{Mpc}`).</span>
<span class="sd">    order : int</span>
<span class="sd">        Order of the multipole, ``order &gt;= 0``.</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Redshift.</span>
<span class="sd">    correction_value : float or None, optional</span>
<span class="sd">        If not `None` (default), this is directly used as</span>
<span class="sd">        :math:`\mathcal{H} g(z)` at `redshift` in calculations, and</span>
<span class="sd">        `cosmo`, `geometric`, `evolution_bias` and `magnification_bias`</span>
<span class="sd">        are ignored.</span>
<span class="sd">    cosmo : :class:`nbodykit.cosmology.Cosmology`, optional</span>
<span class="sd">        Cosmological model (default is ``FIDUCIAL_COSMOLOGY``).</span>
<span class="sd">    geometric : bool, optional</span>
<span class="sd">        If `True` (default), include geometric contributions from the</span>
<span class="sd">        background expansion.</span>
<span class="sd">    evolution_bias : float or callable or None, optional</span>
<span class="sd">        Evolution bias as a function of redshift, or evaluated at input</span>
<span class="sd">        `redshift` (default is `None`).  If callable/float,</span>
<span class="sd">        `magnification_bias` must also be callable/float.</span>
<span class="sd">    magnification_bias : float or callable or None, optional</span>
<span class="sd">        Magnification bias as a function of redshift, or evaluated at input</span>
<span class="sd">        `redshift` (default is `None`).  If callable/float,</span>
<span class="sd">        `evolution_bias` must also be callable/float.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    factor : float :class:`numpy.ndarray`</span>
<span class="sd">        Power spectrum multipoles as multiples of the matter power</span>
<span class="sd">        spectrum.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">correction_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">evolution_bias</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">magnification_bias</span><span class="p">):</span>
            <span class="n">correction_function</span> <span class="o">=</span> <span class="n">relativistic_correction_func</span><span class="p">(</span>
                <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
                <span class="n">geometric</span><span class="o">=</span><span class="n">geometric</span><span class="p">,</span>
                <span class="n">evolution_bias</span><span class="o">=</span><span class="n">evolution_bias</span><span class="p">,</span>
                <span class="n">magnification_bias</span><span class="o">=</span><span class="n">magnification_bias</span>
            <span class="p">)</span>
            <span class="n">correction_value</span> <span class="o">=</span> <span class="n">correction_function</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evolution_bias</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnification_bias</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">correction_value</span> <span class="o">=</span> <span class="n">relativistic_correction_value</span><span class="p">(</span>
                <span class="n">redshift</span><span class="p">,</span>
                <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
                <span class="n">geometric</span><span class="o">=</span><span class="n">geometric</span><span class="p">,</span>
                <span class="n">evolution_bias</span><span class="o">=</span><span class="n">evolution_bias</span><span class="p">,</span>
                <span class="n">magnification_bias</span><span class="o">=</span><span class="n">magnification_bias</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">evolution_bias</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">magnification_bias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction_value</span> <span class="o">=</span> <span class="n">relativistic_correction_value</span><span class="p">(</span>
                <span class="n">redshift</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">geometric</span><span class="o">=</span><span class="n">geometric</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;`evolution_bias` and `magnification_bias` must be &quot;</span>
                <span class="s2">&quot;both callable or float or None.&quot;</span>
            <span class="p">)</span>

    <span class="n">modification</span> <span class="o">=</span> <span class="n">correction_value</span> <span class="o">**</span> <span class="mi">2</span> \
        <span class="o">*</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">scale_independent_growth_rate</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> \
        <span class="o">/</span> <span class="n">wavenumber</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">modification</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">modification</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">factor</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy; Copyright 2020, Mike Shengbo Wang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>