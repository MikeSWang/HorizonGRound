
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>horizonground.lumfunc_modeller &#8212; HorizonGRound 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/HorizonGRound.png" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick_recipes.html">Quick Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc.html">API Reference</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for horizonground.lumfunc_modeller</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Luminosity function modeller (:mod:`~horizonground.lumfunc_modeller`)</span>
<span class="sd">===========================================================================</span>

<span class="sd">Provide models of the redshift-dependent tracer luminosity function</span>
<span class="sd">:math:`\Phi(m, z)` (for absolute magnitude :math:`m`) or</span>
<span class="sd">:math:`\Phi(\lg{L}, z)` (for base-10 logarithm of the intrinsic</span>
<span class="sd">luminosity :math:`L`), from which the comoving number density below/above</span>
<span class="sd">some brightness threshold :math:`\bar{m}` or :math:`\bar{L}`,</span>

<span class="sd">.. math::</span>

<span class="sd">    \bar{n}(z; &lt;\!\bar{m}) = \int_{-\infty}^{\bar{m}}</span>
<span class="sd">        \operatorname{d}\!m\, \Phi(m, z)</span>
<span class="sd">    \quad \mathrm{or} \quad</span>
<span class="sd">    \bar{n}(z; &gt;\!\lg\bar{L}) = \int^{\infty}_{\lg\bar{L}}</span>
<span class="sd">        \operatorname{d}\!\lg{L}\, \Phi(\lg{L}, z) \,,</span>

<span class="sd">can be predicted.  The corresponding evolution bias is</span>

<span class="sd">.. math::</span>

<span class="sd">    b_\mathrm{e}(z) = - (1 + z)</span>
<span class="sd">        \frac{\partial \ln\bar{n}(z)}{\partial z}</span>

<span class="sd">and magnification bias is</span>

<span class="sd">.. math::</span>

<span class="sd">    s(z) = \frac{1}{\ln10}</span>
<span class="sd">        \frac{\Phi(\bar{m},z)}{\bar{n}(z; &lt;\!\bar{m})}</span>
<span class="sd">    \quad \mathrm{or} \quad</span>
<span class="sd">    s(z) = \frac{2}{5\ln10}</span>
<span class="sd">        \frac{\Phi(\lg\bar{L},z)}{\bar{n}(z; &gt;\!\lg\bar{L})}</span>
<span class="sd">    \,,</span>

<span class="sd">We also offer a simple :math:`K`-correction formula taken from ref. [1]_.</span>

<span class="sd">.. [1] Croom S. M. et al., 2009. **MNRAS** 399(4), 1755--1772.</span>
<span class="sd">   [arXiv: `0907.2727 &lt;https://arxiv.org/abs/0907.2727&gt;`_]</span>


<span class="sd">.. autosummary::</span>

<span class="sd">    LumFuncModeller</span>
<span class="sd">    konstante_correction</span>


<span class="sd">Quasar (QSO) luminosity function</span>
<span class="sd">---------------------------------------------------------------------------</span>

<span class="sd">**Pure luminosity evolution model (PLE)**</span>

<span class="sd">The quasar luminosity function in the pure luminosity evolution (PLE)</span>
<span class="sd">model is a double power law</span>

<span class="sd">.. math::</span>

<span class="sd">    \Phi(m, z) = \frac{\Phi_\ast}{</span>
<span class="sd">        10^{0.4 (\alpha + 1) [m - m_\ast(z)]}</span>
<span class="sd">        + 10^{0.4 (\beta + 1) [m - m_\ast(z)]}</span>
<span class="sd">    }</span>

<span class="sd">where :math:`m` is the absolute magnitude, :math:`z` is the redshift, and</span>
<span class="sd">the slope parameters :math:`\alpha, \beta` describe the power laws on the</span>
<span class="sd">bright and faint ends respectively, but their values differ below and</span>
<span class="sd">above the pivot redshift :math:`z_\mathrm{p}`.  :math:`m_\ast` is the</span>
<span class="sd">break magnitude at which the luminosity function evaluates to</span>
<span class="sd">:math:`\Phi_\ast`,</span>

<span class="sd">.. math::</span>

<span class="sd">    m_\ast(z) = m_\ast(z_\mathrm{p}) - \frac{5}{2} \left[</span>
<span class="sd">        k_1 (z - z_\mathrm{p}) + k_2 (z - z_\mathrm{p})^2</span>
<span class="sd">    \right] \,,</span>

<span class="sd">where :math:`k_1, k_2` are the redshift-evolution parameters whose values</span>
<span class="sd">also differ below and above the pivot redshift [2]_.</span>

<span class="sd">This is a parametric model with 10 parameters: :math:`\lg\Phi_\ast`,</span>
<span class="sd">:math:`m_\ast(z_\mathrm{p})`, :math:`(\alpha, \beta, k_1, k_2)_\mathrm{l}`</span>
<span class="sd">for :math:`z &lt; z_\mathrm{p}` and :math:`(\alpha, \beta, k_1,</span>
<span class="sd">k_2)_\mathrm{h}` for :math:`z &gt; z_\mathrm{p}`.   Due to the exchange</span>
<span class="sd">symmetry between :math:`\alpha` and :math:`\beta` in the double power law,</span>
<span class="sd">the model constraint :math:`\alpha &lt; \beta` is imposed for both above</span>
<span class="sd">and below the pivot redshift.</span>


<span class="sd">**Hybrid evolution model (PLE+LEDE)**</span>

<span class="sd">This model is the same as the PLE model below the pivot redshift, but</span>
<span class="sd">above that the luminosity evolution--density evolution (LEDE) model is</span>
<span class="sd">adopted where the luminosity function normalisation, break magnitude and</span>
<span class="sd">bright-end power law index have different redshift evolutions</span>

<span class="sd">.. math::</span>

<span class="sd">    \begin{align*}</span>
<span class="sd">        \lg\Phi_\ast &amp;= \lg\Phi_\ast(z_\mathrm{p}) \</span>
<span class="sd">            + c_{1\mathrm{a}} (z - z_\mathrm{p})</span>
<span class="sd">            + c_{1\mathrm{b}} (z - z_\mathrm{p})^2 \,, \\</span>
<span class="sd">        m_\ast(z) &amp;= m_\ast(z_\mathrm{p}) + c_2 (z - z_\mathrm{p}) \,, \\</span>
<span class="sd">        \alpha(z) &amp;= \alpha(z_\mathrm{p}) + c_3 (z - z_\mathrm{p}) \,,</span>
<span class="sd">    \end{align*}</span>

<span class="sd">and continuity across redshift is imposed by requiring the same</span>
<span class="sd">:math:`\lg\Phi_\ast(z_\mathrm{p})` and :math:`m_\ast(z_\mathrm{p})` for</span>
<span class="sd">two models [2]_.</span>

<span class="sd">The hybrid model still has 10 overall parameters: the PLE model retains 6</span>
<span class="sd">low-redshift parameters and the high-redshift LEDE model has 8 parameters,</span>
<span class="sd">with the substitutions of :math:`\lg\Phi_\ast(0)` for :math:`\lg\Phi_\ast`,</span>
<span class="sd">:math:`m_\ast(0)` for :math:`m_\ast(z_\mathrm{p})`, :math:`c_2` for</span>
<span class="sd">:math:`k_1, k_2` and the addition of</span>
<span class="sd">:math:`c_{1\mathrm{a}}, c_{1\mathrm{b}}` and :math:`c_3`.  As before, due</span>
<span class="sd">to the exchange symmetry between :math:`\alpha` and :math:`\beta`, the</span>
<span class="sd">low-redshift PLE model constraint :math:`\alpha &lt; \beta` is imposed.</span>

<span class="sd">.. [2] Palanque-Delabrouille N. et al., 2016. **A&amp;A** 587, A41.</span>
<span class="sd">   [arXiv: `1509.05607 &lt;https://arxiv.org/abs/1509.05607&gt;`_]</span>


<span class="sd">.. autosummary::</span>

<span class="sd">    quasar_PLE_lumfunc</span>
<span class="sd">    quasar_PLE_model_constraint</span>
<span class="sd">    quasar_hybrid_lumfunc</span>
<span class="sd">    quasar_hybrid_model_constraint</span>


<span class="sd">H |alpha| -emitter luminosity function</span>
<span class="sd">---------------------------------------------------------------------------</span>

<span class="sd">**Schechter function model**</span>

<span class="sd">The H |alpha| -emitter luminosity function in the Schechter function model</span>
<span class="sd">takes the form of a gamma function</span>

<span class="sd">.. math::</span>

<span class="sd">    \Phi(L, z) \operatorname{d}\!L = \underbrace{</span>
<span class="sd">        \ln10 \, \Phi_\ast(z) y(z)^{\alpha+1} \mathrm{e}^{-y(z)}</span>
<span class="sd">    }_{\Phi(\lg{L}, z)} \operatorname{d}\!\lg{L}</span>

<span class="sd">where :math:`\alpha` is the faint-end slope parameter,</span>

<span class="sd">.. math::</span>

<span class="sd">    \begin{align*}</span>
<span class="sd">        \Phi_\ast(z) &amp;=</span>
<span class="sd">            \begin{cases}</span>
<span class="sd">                \Phi_{\ast0} (1 + z)^\epsilon \,,</span>
<span class="sd">                    \quad z \leqslant z_\mathrm{b} \,; \\</span>
<span class="sd">                \Phi_{\ast0} (1 + z_\mathrm{b})^{2\epsilon}</span>
<span class="sd">                    (1 + z)^{-\epsilon} \,, \quad z &gt; z_\mathrm{b} \,,</span>
<span class="sd">            \end{cases} \\</span>
<span class="sd">        y(z) &amp;= \frac{L}{L_{\ast0}} (1 + z)^{-\delta} \,,</span>
<span class="sd">    \end{align*}</span>

<span class="sd">are the redshift-dependent characteristic comoving number density and</span>
<span class="sd">relative luminosity of the H |alpha| -emitters, :math:`\epsilon, \delta`</span>
<span class="sd">are the redshift-evolution indices, and :math:`z_\mathrm{b}` is the break</span>
<span class="sd">magnitude [3]_.</span>

<span class="sd">This is a parametric model with 6 parameters: :math:`\alpha, \epsilon,</span>
<span class="sd">\delta`, :math:`z_\mathrm{b}`, :math:`m_{\ast0}` and :math:`\Phi_{\ast0}`.</span>

<span class="sd">.. [3] Pozzetti L. et al., 2016. **A&amp;A** 590, A3.</span>
<span class="sd">   [arXiv: `1603.01453 &lt;https://arxiv.org/abs/1603.01453&gt;`_]</span>


<span class="sd">.. autosummary::</span>

<span class="sd">    alpha_emitter_schechter_lumfunc</span>

<span class="sd">|</span>

<span class="sd">.. |alpha| unicode:: U+03B1</span>
<span class="sd">    :trim:</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">derivative</span>


<div class="viewcode-block" id="konstante_correction"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.konstante_correction">[docs]</a><span class="k">def</span> <span class="nf">konstante_correction</span><span class="p">(</span><span class="n">redshift</span><span class="p">,</span> <span class="n">normalisation_redshift</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Subtractive Konstante correction (*K*-correction) to apparent</span>
<span class="sd">    magnitude for correcting bandpass redshifting.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This implements the subtractive *K*-correction :math:`K(z) - K(z_\ast)`</span>
<span class="sd">    normalised to redshift :math:`z_\ast`, where</span>

<span class="sd">    .. math::</span>

<span class="sd">        K(z) = - \frac{5}{2} (1 + \alpha_\nu) \lg(1 + z)</span>

<span class="sd">    and :math:`\alpha_\nu` is the power-law index.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Redshift.</span>
<span class="sd">    normalisation_redshift : float, optional</span>
<span class="sd">        Normalisation redshift (default is 2.).</span>
<span class="sd">    index : float, optional</span>
<span class="sd">        :math:`K`-correction power-law index (default is -0.5).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    correction_magnitude : float</span>
<span class="sd">        The magnitude correction that needs to be subtracted from the</span>
<span class="sd">        observed magnitude.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span> <span class="mf">5.</span><span class="o">/</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span> \
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">normalisation_redshift</span><span class="p">))</span></div>


<div class="viewcode-block" id="quasar_PLE_lumfunc"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.quasar_PLE_lumfunc">[docs]</a><span class="k">def</span> <span class="nf">quasar_PLE_lumfunc</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">base10_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">redshift_pivot</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="o">**</span><span class="n">model_parameters</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Evaluate the pure luminosity evolution (PLE) model for the quasar</span>
<span class="sd">    luminosity function at the given absolute magnitude and redshift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    magnitude : float</span>
<span class="sd">        Quasar absolute magnitude.</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Quasar redshift.</span>
<span class="sd">    base10_log : bool, optional</span>
<span class="sd">        If `True` (default), return the base-10 logarithmic value.</span>
<span class="sd">    redshift_pivot : float, optional</span>
<span class="sd">        Pivot redshift.</span>
<span class="sd">    **model_parameters</span>
<span class="sd">        PLE model parameters.  Must be passed with the following</span>
<span class="sd">        parameter names:</span>
<span class="sd">        ``r&#39;\lg\Phi_\ast&#39;``, ``r&#39;m_\ast(z_\mathrm{p})&#39;``,</span>
<span class="sd">        ``r&#39;\alpha_\mathrm{{l}}&#39;``, ``r&#39;\beta_\mathrm{{l}}&#39;``,</span>
<span class="sd">        ``r&#39;k_{{1\mathrm{{l}}}}&#39;``, ``r&#39;k_{{2\mathrm{{l}}}}&#39;``,</span>
<span class="sd">        ``r&#39;\alpha_\mathrm{{h}}&#39;``, ``r&#39;\beta_\mathrm{{h}}&#39;``,</span>
<span class="sd">        ``r&#39;k_{{1\mathrm{{h}}}}&#39;``, ``r&#39;k_{{2\mathrm{{h}}}}&#39;``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lumfunc_value : float</span>
<span class="sd">        Predicted qausar luminosity function value (in inverse cubic Mpc</span>
<span class="sd">        per unit magnitude).  Base-10 logarithmic value is returned if</span>
<span class="sd">        `base10_log` is `True`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is not vectorised.  Please use `numpy.vectorize` or</span>
<span class="sd">    `functools` if you need vectorisation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model parameters must be passed as a dictionary.&quot;</span><span class="p">)</span>

    <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z_p</span> <span class="o">=</span> <span class="n">magnitude</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">redshift_pivot</span>

    <span class="c1"># Determine the redshift end for setting parameters.</span>
    <span class="n">subscript</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\mathrm{{</span><span class="si">{}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">z_p</span> \
        <span class="k">else</span> <span class="sa">r</span><span class="s1">&#39;\mathrm{{</span><span class="si">{}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\alpha_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscript</span><span class="p">)]</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\beta_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscript</span><span class="p">)]</span>
    <span class="n">k_1</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;k_{{1</span><span class="si">{}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscript</span><span class="p">)]</span>
    <span class="n">k_2</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;k_{{2</span><span class="si">{}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscript</span><span class="p">)]</span>

    <span class="n">lg_Phi_star</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\lg\Phi_\ast&#39;</span><span class="p">]</span>
    <span class="n">m_star_at_z_p</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;m_\ast(z_\mathrm</span><span class="si">{p}</span><span class="s1">)&#39;</span><span class="p">]</span>

    <span class="c1"># Evaluate the model prediction.</span>
    <span class="n">magnitude_deviation_exponent</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">m_star_at_z_p</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_1</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_p</span><span class="p">)</span> <span class="o">+</span> <span class="n">k_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_p</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">ln_faint_power_law</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">magnitude_deviation_exponent</span><span class="p">)</span>
    <span class="n">ln_bright_power_law</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">magnitude_deviation_exponent</span><span class="p">)</span>

    <span class="n">ln_denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="n">ln_faint_power_law</span><span class="p">,</span> <span class="n">ln_bright_power_law</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">base10_log</span><span class="p">:</span>
        <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">lg_Phi_star</span> <span class="o">-</span> <span class="n">ln_denominator</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Phi_star</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">lg_Phi_star</span>
        <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">Phi_star</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_denominator</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lumfunc_value</span></div>


<div class="viewcode-block" id="quasar_PLE_model_constraint"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.quasar_PLE_model_constraint">[docs]</a><span class="k">def</span> <span class="nf">quasar_PLE_model_constraint</span><span class="p">(</span><span class="o">**</span><span class="n">model_parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether the pure luminosity evolution (PLE) model constraint</span>
<span class="sd">    is satisfied.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    **model_parameters</span>
<span class="sd">        PLE model parameters.  See :func:`quasar_PLE_lumfunc` for required</span>
<span class="sd">        parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether or not the model constraint is satisfied.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\alpha_\mathrm</span><span class="si">{l}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="o">&lt;</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\beta_\mathrm</span><span class="si">{l}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\alpha_\mathrm</span><span class="si">{h}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="o">&lt;</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\beta_\mathrm</span><span class="si">{h}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="quasar_hybrid_lumfunc"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.quasar_hybrid_lumfunc">[docs]</a><span class="k">def</span> <span class="nf">quasar_hybrid_lumfunc</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">base10_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">redshift_pivot</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="o">**</span><span class="n">model_parameters</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Evaluate the hybrid model (pure luminosity evolution and luminosity</span>
<span class="sd">    evolution--density evolution, &#39;PLE+LEDE&#39;) for the quasar luminosity</span>
<span class="sd">    function at the given absolute magnitude and redshift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    magnitude : float</span>
<span class="sd">        Quasar absolute magnitude.</span>
<span class="sd">    redshift : float</span>
<span class="sd">        Quasar redshift.</span>
<span class="sd">    base10_log : bool, optional</span>
<span class="sd">        If `True` (default), return the base-10 logarithmic value.</span>
<span class="sd">    redshift_pivot : float, optional</span>
<span class="sd">        Pivot redshift.</span>
<span class="sd">    **model_parameters</span>
<span class="sd">        Hybrid model parameters.  Must be passed with the following</span>
<span class="sd">        parameter names: ``r&#39;\lg\Phi_\ast(0)&#39;``, ``r&#39;m_\ast(0)&#39;``,</span>
<span class="sd">        ``r&#39;\alpha&#39;``, ``r&#39;\beta&#39;``, ``r&#39;k_1&#39;``, ``r&#39;k_2&#39;``,</span>
<span class="sd">        ``r&#39;c_{{1\mathrm{{a}}}}&#39;``, ``r&#39;c_{{1\mathrm{{b}}}}&#39;``,</span>
<span class="sd">        ``r&#39;c_2&#39;``, ``r&#39;k_3&#39;``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lumfunc_value : float</span>
<span class="sd">        Predicted qausar luminosity function value (in inverse cubic Mpc</span>
<span class="sd">        per unit magnitude).  Base-10 logarithmic value is returned if</span>
<span class="sd">        `base10_log` is `True`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is not vectorised.  Please use `numpy.vectorize` or</span>
<span class="sd">    `functools` if you need vectorisation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model parameters must be passed as a dictionary.&quot;</span><span class="p">)</span>

    <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z_p</span> <span class="o">=</span> <span class="n">magnitude</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">redshift_pivot</span>

    <span class="c1"># Low redshift PLE model.</span>
    <span class="n">lg_Phi_star_0</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\lg\Phi_\ast(0)&#39;</span><span class="p">]</span>
    <span class="n">m_star_0</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;m_\ast(0)&#39;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\alpha&#39;</span><span class="p">]</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\beta&#39;</span><span class="p">]</span>
    <span class="n">k_1</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;k_1&#39;</span><span class="p">]</span>
    <span class="n">k_2</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;k_2&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">z_p</span><span class="p">:</span>

        <span class="n">magnitude_deviation_exponent</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">m_star_0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_1</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">k_2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">ln_faint_power_law</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">magnitude_deviation_exponent</span><span class="p">)</span>
        <span class="n">ln_bright_power_law</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">magnitude_deviation_exponent</span><span class="p">)</span>

        <span class="n">ln_denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="n">ln_faint_power_law</span><span class="p">,</span> <span class="n">ln_bright_power_law</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base10_log</span><span class="p">:</span>
            <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">lg_Phi_star_0</span> <span class="o">-</span> <span class="n">ln_denominator</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Phi_star</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">lg_Phi_star_0</span>
            <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">Phi_star</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_denominator</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lumfunc_value</span>

    <span class="c1"># High redshift LEDE model.</span>
    <span class="n">c_1a</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;c_{1\mathrm</span><span class="si">{a}</span><span class="s1">}&#39;</span><span class="p">]</span>
    <span class="n">c_1b</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;c_{1\mathrm</span><span class="si">{b}</span><span class="s1">}&#39;</span><span class="p">]</span>
    <span class="n">c_2</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;c_2&#39;</span><span class="p">]</span>
    <span class="n">c_3</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;c_3&#39;</span><span class="p">]</span>

    <span class="n">lg_Phi_star_at_z_p</span> <span class="o">=</span> <span class="n">lg_Phi_star_0</span>
    <span class="n">m_star_at_z_p</span> <span class="o">=</span> <span class="n">m_star_0</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_1</span> <span class="o">*</span> <span class="n">z_p</span> <span class="o">+</span> <span class="n">k_2</span> <span class="o">*</span> <span class="n">z_p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">lg_Phi_star</span> <span class="o">=</span> <span class="n">lg_Phi_star_at_z_p</span> <span class="o">+</span> <span class="n">c_1a</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_p</span><span class="p">)</span> <span class="o">+</span> <span class="n">c_1b</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_p</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">magnitude_deviation_exponent</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">m_star_at_z_p</span><span class="p">)</span> <span class="o">+</span> <span class="n">c_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_p</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">c_3</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_p</span><span class="p">)</span>

    <span class="n">ln_faint_power_law</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">magnitude_deviation_exponent</span><span class="p">)</span>
    <span class="n">ln_bright_power_law</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">magnitude_deviation_exponent</span><span class="p">)</span>

    <span class="n">ln_denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="n">ln_faint_power_law</span><span class="p">,</span> <span class="n">ln_bright_power_law</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">base10_log</span><span class="p">:</span>
        <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">lg_Phi_star</span> <span class="o">-</span> <span class="n">ln_denominator</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Phi_star</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">lg_Phi_star</span>
        <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">Phi_star</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_denominator</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lumfunc_value</span></div>


<div class="viewcode-block" id="quasar_hybrid_model_constraint"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.quasar_hybrid_model_constraint">[docs]</a><span class="k">def</span> <span class="nf">quasar_hybrid_model_constraint</span><span class="p">(</span><span class="o">**</span><span class="n">model_parameters</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Check whether the hybrid model constraint is satisfied.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    **model_parameters</span>
<span class="sd">        Hybrid model parameters.  See :func:`quasar_hybrid_lumfunc` for</span>
<span class="sd">        required parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether or not the model constraint is satisfied.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\alpha&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\beta&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="alpha_emitter_schechter_lumfunc"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.alpha_emitter_schechter_lumfunc">[docs]</a><span class="k">def</span> <span class="nf">alpha_emitter_schechter_lumfunc</span><span class="p">(</span><span class="n">luminosity</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">base10_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">model_parameters</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Evaluate the Schechter model for the H |alpha| -emitter</span>
<span class="sd">    luminosity function at the given intrinsic luminosity and redshift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    luminosity : float</span>
<span class="sd">        H |alpha| -emitter luminosity in dex (base-10 logarithm).</span>
<span class="sd">    redshift : float</span>
<span class="sd">        H |alpha| -emitter redshift.</span>
<span class="sd">    base10_log : bool, optional</span>
<span class="sd">        If `True` (default), return the base-10 logarithmic value.</span>
<span class="sd">    **model_parameters</span>
<span class="sd">        Schechter model parameters.  Must be passed with the following</span>
<span class="sd">        parameter names: ``r&#39;\lg\Phi_{\ast0}&#39;``, ``r&#39;\lg{L_{\ast0}}&#39;``,</span>
<span class="sd">        ``r&#39;z_\mathrm{b}&#39;``, ``r&#39;\alpha&#39;``, ``r&#39;\delta&#39;``, ``r&#39;\epsilon&#39;``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lumfunc_value : float</span>
<span class="sd">        Predicted H |alpha| -emitter luminosity function value (in inverse</span>
<span class="sd">        cubic Mpc per flux dex).  Base-10 logarithmic value is returned if</span>
<span class="sd">        `base10_log` is `True`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is not vectorised.  Please use `numpy.vectorize` or</span>
<span class="sd">    `functools` if you need vectorisation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lg_L</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">luminosity</span><span class="p">,</span> <span class="n">redshift</span>

    <span class="n">lg_Phi_star0</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\lg\Phi_{\ast0}&#39;</span><span class="p">]</span>
    <span class="n">lg_L_star0</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\lg{L_{\ast0}}&#39;</span><span class="p">]</span>
    <span class="n">z_b</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;z_\mathrm</span><span class="si">{b}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\alpha&#39;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\delta&#39;</span><span class="p">]</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">model_parameters</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\epsilon&#39;</span><span class="p">]</span>

    <span class="c1"># Evaluate the model prediction.</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">z_b</span><span class="p">:</span>
        <span class="n">lg_Phi_star</span> <span class="o">=</span> <span class="n">lg_Phi_star0</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lg_Phi_star</span> <span class="o">=</span> <span class="n">lg_Phi_star0</span> \
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z_b</span><span class="p">)</span> \
            <span class="o">-</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>

    <span class="n">lg_y</span> <span class="o">=</span> <span class="n">lg_L</span> <span class="o">-</span> <span class="n">lg_L_star0</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">base10_log</span><span class="p">:</span>
        <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="n">lg_Phi_star</span> \
            <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lg_y</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">lg_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lumfunc_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">lg_Phi_star</span> \
            <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">lg_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">lg_y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lumfunc_value</span></div>


<div class="viewcode-block" id="LumFuncModeller"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.LumFuncModeller">[docs]</a><span class="k">class</span> <span class="nc">LumFuncModeller</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Luminosity function modeller predicting the comoving number</span>
<span class="sd">    density, evolution bias and magnification bias for a given brightness</span>
<span class="sd">    threshold.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_lumfunc : callable</span>
<span class="sd">        A parametric luminosity function model as a function of brightness</span>
<span class="sd">        and redshift (in that order) in units of inverse cubic Mpc.  If it</span>
<span class="sd">        returns the luminosity function value in base-10 logarithm,</span>
<span class="sd">        `exponentiation` should be set to `True`; if it accepts a boolean</span>
<span class="sd">        parameter &#39;base10_log&#39;, this will be overriden to `False`.</span>
<span class="sd">    model_parameters : dict</span>
<span class="sd">        Model parameters passed to `model_lumfunc` as keyword arguments.</span>
<span class="sd">    brightness_variable : {&#39;luminosity&#39;, &#39;magnitude&#39;}, str</span>
<span class="sd">        Brightness variable of `model_lumfunc`, either &#39;luminosity&#39; (in</span>
<span class="sd">        dex) or &#39;magnitude&#39;.</span>
<span class="sd">    threshold_value : float</span>
<span class="sd">        Brightness threshold value for `brightness_variable`.  If</span>
<span class="sd">        `brightness_variable` is &#39;luminosity&#39;, this is interpreted as a</span>
<span class="sd">        flux limit and converted to an intrinsic luminosity value at the</span>
<span class="sd">        tracer redshift using the luminosity distance.</span>
<span class="sd">    normalise_threshold : bool, optional</span>
<span class="sd">        If `True` (default is `False`), `threshold_value` is converted</span>
<span class="sd">        from a flux limit to a luminosity value at `normalisation_redshift`</span>
<span class="sd">        using the luminosity distance if `brightness_variable` is</span>
<span class="sd">        &#39;luminosity&#39;, or converted from an apparent magnitude limit to</span>
<span class="sd">        an absolute magnitude value at `normalisation_redshift` using the</span>
<span class="sd">        distance modulus if `brightness_variable` is &#39;magnitude&#39;.</span>
<span class="sd">    normalisation_redshift : float or None, optional</span>
<span class="sd">        If not `None` (default) and `normalise_threshold` is `True`, this</span>
<span class="sd">        redshift is used convert flux or apparent magnitude limit to an</span>
<span class="sd">        intrinsic luminosity or absolute magnitude threshold.</span>
<span class="sd">    cosmology : :class:`astropy.cosmology.core.Cosmology` or None, optional</span>
<span class="sd">        Background cosmological model used to calculate the luminosity</span>
<span class="sd">        distance or distance modulus (default is `None`).</span>
<span class="sd">    exponentiation : bool, optional</span>
<span class="sd">        If `True` (default is `False`), this assumes `model_lumfunc` only</span>
<span class="sd">        returns the base-10 logarithmic luminosity function and</span>
<span class="sd">        exponentiate its returned value to a power of 10.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    luminosity_function : callable</span>
<span class="sd">        Luminosity function of brightness and redshift variables only</span>
<span class="sd">        (in that order) (in inverse cubic :math:`\mathrm{Mpc}/h` per unit</span>
<span class="sd">        luminosity).</span>
<span class="sd">    brightness_threshold : callable</span>
<span class="sd">        Intrinsic luminosity or absoloute magnitude threshold, depending</span>
<span class="sd">        on the input argument of `brightness_variable`, as a function</span>
<span class="sd">        of redshift.</span>
<span class="sd">    cosmology : :class:`astropy.cosmology.core.Cosmology`</span>
<span class="sd">        Background cosmological model.</span>
<span class="sd">    attrs : dict</span>
<span class="sd">        Model parameters and luminosity variables stored in a dictionary.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    :attr:`luminosity_function` is a vectorised function.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">luminosity_bound</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;luminosity&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
        <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">50.</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;float: Finite luminosity upper bound for numerical integration.</span>

<span class="sd">    If :attr:`brightness_variable` is &#39;luminosity&#39;, the bound is given as</span>
<span class="sd">    a base-10 logarithmic flux value in erg/s; else if &#39;magnitude&#39;,</span>
<span class="sd">    the bound is dimensionless.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">redshift_stepsize</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;float: Redshift step size for numerical differentiation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_lumfunc</span><span class="p">,</span> <span class="n">model_parameters</span><span class="p">,</span> <span class="n">brightness_variable</span><span class="p">,</span>
                 <span class="n">threshold_value</span><span class="p">,</span> <span class="n">normalise_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">normalisation_redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exponentiation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model_parameters&#39;</span><span class="p">:</span> <span class="n">model_parameters</span><span class="p">,</span>
            <span class="s1">&#39;brightness_variable&#39;</span><span class="p">:</span> <span class="n">brightness_variable</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span> <span class="o">=</span> <span class="n">cosmology</span>

        <span class="k">if</span> <span class="s1">&#39;base10_log&#39;</span> <span class="ow">in</span> <span class="n">signature</span><span class="p">(</span><span class="n">model_lumfunc</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">model_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;base10_log&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="c1"># pylint: disable=unnecessary-lambda</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">luminosity_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">lum</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">model_lumfunc</span><span class="p">(</span><span class="n">lum</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">model_parameters</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">exponentiation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">luminosity_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">lum</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">model_lumfunc</span><span class="p">(</span><span class="n">lum</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">model_parameters</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">luminosity_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">lum</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">model_lumfunc</span><span class="p">(</span><span class="n">lum</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">model_parameters</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">brightness_variable</span> <span class="o">==</span> <span class="s1">&#39;luminosity&#39;</span><span class="p">:</span>
            <span class="c1"># pylint: disable=no-member</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brightness_threshold</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">threshold_value</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_brightness_threshold</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">brightness_threshold</span><span class="p">(</span><span class="n">normalisation_redshift</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">brightness_variable</span> <span class="o">==</span> <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brightness_threshold</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> \
                <span class="n">threshold_value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">distmod</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> \
                <span class="k">if</span> <span class="n">normalise_threshold</span> <span class="k">else</span> <span class="n">threshold_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_brightness_threshold</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">brightness_threshold</span><span class="p">(</span><span class="n">normalisation_redshift</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">normalise_threshold</span> <span class="k">else</span> <span class="n">threshold_value</span>

<div class="viewcode-block" id="LumFuncModeller.from_parameter_file"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.LumFuncModeller.from_parameter_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_parameter_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parameter_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate the modeller class with model parameter values</span>
<span class="sd">        loaded from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_file : *str or* :class:`pathlib.Path`</span>
<span class="sd">            Path of the model parameter file.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Parameters other than `model_parameters` passed to the</span>
<span class="sd">            modeller class as keyword arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pfile</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">var_name</span><span class="p">:</span> <span class="n">var_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="n">pfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">estimates</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">pfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>

        <span class="n">model_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">estimates</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">model_parameters</span><span class="o">=</span><span class="n">model_parameters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LumFuncModeller.comoving_number_density"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.LumFuncModeller.comoving_number_density">[docs]</a>    <span class="k">def</span> <span class="nf">comoving_number_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the comoving number density :math:`\bar{n}(z)`</span>
<span class="sd">        above the luminosity threshold at a given redshift.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        redshift : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Comoving number density (in inverse cubic</span>
<span class="sd">            :math:`\mathrm{Mpc}/h`).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_comoving_number_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="n">quad</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">luminosity_function</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_brightness_threshold</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">luminosity_bound</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;brightness_variable&#39;</span><span class="p">]],</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">redshift</span><span class="p">,)</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">h</span> <span class="o">**</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">_comoving_number_density</span></div>

<div class="viewcode-block" id="LumFuncModeller.evolution_bias"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.LumFuncModeller.evolution_bias">[docs]</a>    <span class="k">def</span> <span class="nf">evolution_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the evolution bias :math:`b_\mathrm{e}(z)` at a</span>
<span class="sd">        given redshift.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        redshift : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Evolution bias.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_evolution_bias</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span> <span class="o">*</span> <span class="n">derivative</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comoving_number_density</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift_stepsize</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">comoving_number_density</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_evolution_bias</span></div>

<div class="viewcode-block" id="LumFuncModeller.magnification_bias"><a class="viewcode-back" href="../../horizonground.lumfunc_modeller.html#horizonground.lumfunc_modeller.LumFuncModeller.magnification_bias">[docs]</a>    <span class="k">def</span> <span class="nf">magnification_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the magnification bias :math:`s(z)` at a given redshift.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        redshift : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Magnification bias.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;brightness_variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;luminosity&#39;</span><span class="p">:</span>
            <span class="n">prefactor</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">5.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;brightness_variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span>
            <span class="n">prefactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">_magnification_bias</span> <span class="o">=</span> <span class="n">prefactor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosity_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_brightness_threshold</span><span class="p">,</span> <span class="n">redshift</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">comoving_number_density</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_magnification_bias</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy; Copyright 2020, Mike Shengbo Wang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>